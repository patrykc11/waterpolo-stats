<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WTS Stats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --bg:#0b0f14; --fg:#e8edf2; --muted:#9fb0c3; --accent:#4cc9f0; --danger:#ff6b6b; --ok:#51cf66; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--bg); color:var(--fg); }
    header { display:flex; gap:12px; align-items:center; padding:12px 16px; border-bottom:1px solid #1c2632; position:sticky; top:0; background:var(--bg); z-index:2;}
    .tag { padding:6px 10px; background:#13202e; border:1px solid #1f2e40; border-radius:8px; }
    header button, .btn { padding:10px 12px; border-radius:8px; border:1px solid #1f2e40; background:#13202e; color:var(--fg); cursor:pointer; }
    .primary { border-color: var(--accent); }
    .danger { border-color: var(--danger); color:#ffdfe0; }
    .qbtn.selected { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(76,201,240,.25) inset; background:#172230; }
    .wrap { display:grid; grid-template-columns: 320px 1fr; gap:16px; padding:16px; }
    .col { background:#0f1620; border:1px solid #1b2a3a; border-radius:12px; overflow:hidden; }
    .col h3 { margin:0; padding:10px 12px; border-bottom:1px solid #1b2a3a; color:#cde; }
    .players { max-height: calc(100vh - 160px); overflow:auto; padding:8px; display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; }
    .player { display:flex; gap:10px; align-items:center; padding:10px; background:#121c28; border:1px solid #1b2a3a; border-radius:10px; cursor:pointer; }
    .player.active { outline:2px solid var(--accent); }
    .num { width:34px; height:34px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:#172230; color:#9fd0ff; font-weight:700; }
    .panel { padding:12px; display:grid; gap:12px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap:10px; }
    select, .input { padding:8px 10px; border-radius:8px; background:#13202e; color:var(--fg); border:1px solid #1f2e40; }
    .toast { position:fixed; bottom:16px; right:16px; background:#11202a; border:1px solid #1e3446; padding:10px 12px; border-radius:10px; display:none; }
    .muted { color: var(--muted); }
    .tabs { margin-left:auto; display:flex; gap:8px; }
    .hidden { display:none; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:8px; border-bottom:1px solid #1b2a3a; text-align:right; }
    th:first-child, td:first-child { text-align:left; }
    thead th { position:sticky; top:0; background:#0f1620; }
    tfoot td { background:#101926; }
    .small { font-size:12px; color:var(--muted); }
    .two { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .card { padding:12px; background:#0f1620; border:1px solid #1b2a3a; border-radius:12px; }
    .stats-scroll { overflow-x: auto; }
    .stats-scroll table { min-width: 1200px; }
    .subhead { margin:8px 0 4px; color:#cde; font-weight:600; opacity:.9; }
    .seg { display:inline-flex; border:1px solid #1f2e40; border-radius:8px; overflow:hidden; }
    .seg button { border:0; background:#13202e; color:var(--fg); padding:8px 10px; cursor:pointer; }
    .seg button.active { background:#172230; border-right:1px solid #1f2e40; box-shadow: inset 0 0 0 2px rgba(76,201,240,.25); }
    .btn.flash { transform: scale(0.98); filter: brightness(1.1); transition: transform .08s ease, filter .08s ease; }
    #loadingOverlay { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:999; }
    .loaderBox { display:grid; gap:10px; align-items:center; justify-items:center; padding:16px 20px; background:#0f1620; border:1px solid #1b2a3a; border-radius:12px; }
    .spinner { width:42px; height:42px; border-radius:50%; border:3px solid #1f2e40; border-top-color: var(--accent); animation: spin .8s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header>
    <div class="tag">Mecz:
      <select id="matchSel"></select>
    </div>
    <div id="scoreControls" style="display:flex; gap:12px; align-items:center;">
      <div class="tag">Kwarta: <span id="quarter">—</span></div>
      <button id="q1" class="qbtn">Q1</button>
      <button id="q2" class="qbtn">Q2</button>
      <button id="q3" class="qbtn">Q3</button>
      <button id="q4" class="qbtn">Q4</button>
      <button id="undo" class="danger">Cofnij ostatnią akcję</button>
    </div>
    <div style="margin-left:auto"></div>
    <button id="burger" class="btn">☰</button>
  </header>
  <nav id="drawer" style="position:fixed; top:0; right:-320px; width:300px; height:100%; background:#0f1620; border-left:1px solid #1b2a3a; padding:16px; display:grid; gap:12px; transition:right .2s ease; z-index:10;">
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <div class="muted">Menu</div>
      <button id="closeDrawer" class="btn">✕</button>
    </div>
    <button id="tabScore" class="btn primary">Asystent</button>
    <button id="tabStats" class="btn">Statystyki</button>
    <button id="tabAdmin" class="btn">Dodaj nowy mecz</button>
    <button id="openIndex" class="btn">Otwórz Index (arkusz)</button>
  </nav>
  <div id="drawerOverlay" style="position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; z-index:9;"></div>

  <!-- SCOREKEEPER -->
  <div id="modeScore" class="wrap">
    <div class="col">
      <h3>Zawodnicy</h3>
      <div id="players" class="players"></div>
    </div>
    <div class="col">
      <h3>Akcje</h3>
      <div class="panel">
        <div class="muted">Wybrany: <span id="picked">—</span></div>
        

        <div class="card">
          <div class="subhead">Atak</div>
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
            <div class="seg" id="attackSeg">
              <button data-mode="positional" class="active">Atak pozycyjny</button>
              <button data-mode="man_up">Gra w przewadze</button>
            </div>
          </div>
          <div id="attackSections"></div>
        </div>

        <div class="card">
          <div class="subhead">Obrona</div>
          <div class="grid">
            <button class="btn danger" data-action="no_return">Brak powrotu</button>
            <button class="btn danger" data-action="excl_comm_field">Wykluczenie – w polu</button>
            <button class="btn danger" data-action="excl_comm_center">Wykluczenie – z centra</button>
            <button class="btn danger" data-action="pen_comm_field">Karny – w polu</button>
            <button class="btn danger" data-action="pen_comm_center">Karny – z centra</button>
            <button class="btn" data-action="shot_saved">Obrona bramkarza</button>
            <button class="btn" data-action="steal">Przejęcie piłki</button>
            <button class="btn" data-action="block">Blok</button>
            <button class="btn danger" data-action="no_block">Brak bloku</button>
          </div>
        </div>

        <input id="note" class="input" placeholder="Notatka (opcjonalnie)" />
      </div>
    </div>
  </div>

  <!-- STATS -->
  <div id="modeStats" class="wrap hidden">
    <div class="col">
      <h3>Filtry i Wynik</h3>
      <div class="panel">
        <label>Zakres:
          <select id="statsQuarter">
            <option value="all">Cały mecz</option>
            <option value="1">Q1</option>
            <option value="2">Q2</option>
            <option value="3">Q3</option>
            <option value="4">Q4</option>
            <option value="split">Podział na kwarty</option>
          </select>
        </label>

        <div>
          <div class="muted">Wynik (zapis do „Matches”)</div>
          <div class="row" style="display:flex; gap:8px; align-items:center;">
            <select id="scoreQuarter">
              <option value="1">Q1</option>
              <option value="2">Q2</option>
              <option value="3">Q3</option>
              <option value="4">Q4</option>
              <option value="final">Koniec meczu</option>
            </select>
            <input id="scoreMy" class="input" type="number" min="0" placeholder="my" style="width:90px;" />
            <input id="scoreOpp" class="input" type="number" min="0" placeholder="opp" style="width:90px;" />
            <button id="saveScore" class="primary">Zapisz wynik</button>
          </div>
          <div id="scoreSummary" class="small"></div>
        </div>
      </div>
    </div>

    <div class="col">
      <h3>Statystyki</h3>
      <div class="panel stats-scroll">
        <div id="statsTables"></div>
      </div>
    </div>
  </div>

  <!-- ADMIN: new match + roster -->
  <div id="modeAdmin" class="wrap hidden">
    <div class="col">
      <h3>Nowy mecz</h3>
      <div class="panel">
        <div class="two">
          <input id="m_id" class="input" placeholder="match_id (unikalny)" />
          <input id="m_date" class="input" placeholder="data (np. 2025-10-05)" />
        </div>
        <div class="two">
          <input id="m_opponent" class="input" placeholder="przeciwnik" />
          <input id="m_place" class="input" placeholder="miejsce" />
        </div>
        <div class="muted">Wybierz skład i przypisz numery:</div>
        <div id="rosterPick"></div>
        <button id="saveMatch" class="primary">Utwórz/Zapisz mecz</button>
      </div>
    </div>
    <div class="col">
      <h3>Podgląd listy</h3>
      <div class="panel">
        <div id="rosterPreview"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <div id="loadingOverlay">
    <div class="loaderBox">
      <div class="spinner"></div>
      <div class="muted">Ładowanie…</div>
    </div>
  </div>

  <script>
    const EVENTS = [
      { label: 'Gol z gry', type: 'goal', sub: 'from_play' },
      { label: 'G5 (karny)', type: 'goal', sub: 'penalty_5m' },
      { label: 'Gol przewaga', type: 'goal', sub: 'advantage' },
      { label: 'Gol kontra', type: 'goal', sub: 'counter' },
      { label: 'Dobitka', type: 'goal', sub: 'rebound' },
      { label: 'Asysta', type: 'assist', sub: '' },
      { label: 'Sprow. wykl.', type: 'exclusion_drawn', sub: '' },
      { label: 'Spowod. wykl.', type: 'exclusion_caused', sub: '' },
      { label: 'Zła piłka 2m', type: 'bad_ball_2m', sub: '' },
      { label: 'Strzał poza', type: 'shot_off', sub: '' },
      { label: 'Strata', type: 'turnover', sub: '' },
      { label: 'Przechwyt', type: 'steal', sub: '' },
      { label: 'Blok ręką', type: 'block_hand', sub: '' },
      { label: 'Press win', type: 'press_win', sub: '' },
      { label: 'Interception', type: 'interception', sub: '' },
      { label: 'Brak powrotu', type: 'no_return', sub: '' },
    ];

    const FLAG_LABELS = {
      // Gole
      is_goal_from_play: 'G z gry',
      is_goal_from_center: 'G z 2m',
      is_goal_putback: 'Dobitka',
      is_goal_man_up: 'G przewaga',
      is_goal_5m: 'G 5m',
      // Asysty
      is_assist: 'Asysty',
      // Wykluczenia / Karne (sprowokowane/spowodowane)
      is_excl_drawn: 'Sprow. wykl.',
      is_excl_committed: 'Wykl. spowod.',
      is_penalty_drawn: 'Sprow. karny',
      is_penalty_committed: 'Karny spowod.',
      // Straty / podania / zegar
      is_turnover: 'Strata',
      is_turnover_1v1: 'Strata 1:1',
      is_bad_pass_turnover: 'Złe podanie (strata)',
      is_bad_pass_no_turnover: 'Złe podanie (bez straty)',
      is_shot_clock_violation: 'Koniec czasu',
      // Rzuty
      is_shot_saved_gk: 'Obrona GK',
      is_shot_miss_turnover: 'Rzut niecelny (strata)',
      is_shot_miss_reset30: 'Rzut niecelny (30s)',
      // Obrona
      is_steal: 'Przejęcie',
      is_block_hand: 'Blok',
      is_no_block: 'Brak bloku',
      is_no_return: 'Brak powrotu',
      // Stare/ew. rzadkie pola – jeśli pojawią się w arkuszu
      is_goal_counter: 'G kontra',
      is_shot_out: 'Strzał poza',
      is_bad_pass_2m: 'Zła piłka 2m',
      is_press_win: 'Wygrany pressing',
      is_interception: 'Przechwyt (podanie)'
    };

    let STATE = { settings:null, players:[], matches:[], selected:null, stats:null, user:null, viewMatchId:null, rosterActive:[] };
    let ROSTER_FORM = [];
    let EDIT_PIN = null;
    let CAN_WRITE = false;

    const WRITE_QUEUE = [];
    let FLUSH_TIMER = null;

    function enqueueEvent(ev) {
      WRITE_QUEUE.push(ev);
      if (!FLUSH_TIMER) FLUSH_TIMER = setTimeout(flushQueue, 200);
    }
    function flushQueue() {
      const batch = WRITE_QUEUE.splice(0, WRITE_QUEUE.length);
      FLUSH_TIMER = null;
      if (!batch.length) return;
      setLoading(true);
      google.script.run
        .withSuccessHandler(() => { setLoading(false); })
        .withFailureHandler(e => { setLoading(false); toast(e.message || 'Błąd zapisu'); })
        .appendEvents(batch, EDIT_PIN);
    }

    function toast(msg, ms=1400) {
      const t = document.getElementById('toast');
      t.textContent = msg; t.style.display = 'block';
      setTimeout(()=> t.style.display='none', ms);
    }
    function setLoading(on) {
      const ov = document.getElementById('loadingOverlay');
      if (!ov) return;
      ov.style.display = on ? 'flex' : 'none';
    }
    const el = (t,a={},...c)=>{ const e=document.createElement(t);
      Object.entries(a).forEach(([k,v])=> k==='class'?e.className=v : k.startsWith('on')?e.addEventListener(k.slice(2),v) : e.setAttribute(k,v));
      c.forEach(ch=> e.appendChild(typeof ch==='string'?document.createTextNode(ch):ch)); return e; };

    /* ---------- scorekeeper ---------- */

    function renderPlayers() {
      const box = document.getElementById('players'); box.innerHTML='';
      if (!Array.isArray(STATE.players) || STATE.players.length === 0) {
        const info = document.createElement('div');
        info.className = 'muted';
        info.textContent = 'Brak składu dla wybranego meczu';
        box.appendChild(info);
        return;
      }
      STATE.players.forEach(p=>{
        const item = el('div', { class:'player'+(STATE.selected?.player_id===p.player_id?' active':''), onclick:()=>pick(p) },
          el('div', { class:'num' }, String(p.number||'')),
          el('div', {}, p.name)
        );
        box.appendChild(item);
      });
    }

    function renderButtons() {
      // Render dynamicznych sekcji Atak wg trybu (positional | man_up)
      const host = document.getElementById('attackSections');
      if (!host) return;
      host.innerHTML = '';
      const modeBtn = document.querySelector('#attackSeg button.active');
      const mode = modeBtn ? modeBtn.getAttribute('data-mode') : 'positional';

      // Zestawy sekcji
      const sections = [];
      if (mode === 'positional') {
        sections.push({ title: 'Bramki', items: [
          { label:'z akcji', action:'goal_play_pos', phase:'positional' },
          { label:'z kontrataku', action:'goal_play_pos', phase:'counter' },
          { label:'z centra', action:'goal_center_manup', phase:'positional' },
        ]});
        sections.push({ title: 'Asysta', items: [
          { label:'Asysta', action:'assist', phase:'positional' },
        ]});
        sections.push({ title: 'Strata piłki', items: [
          { label:'Obrona bramkarza', action:'shot_saved', phase:'positional', danger:true },
          { label:'Niecelny rzut – strata', action:'miss_turnover', phase:'positional', danger:true },
          { label:'Niecelny rzut – 30s', action:'miss_reset', phase:'positional' },
          { label:'Niecelne podanie – strata', action:'bad_pass_turnover', phase:'positional', danger:true },
          { label:'Niecelne podanie – bez straty', action:'bad_pass_no', phase:'positional' },
          { label:'Strata 1:1', action:'turnover_1v1', phase:'positional', danger:true },
          { label:'Koniec czasu', action:'shot_clock', phase:'positional', danger:true },
        ]});
        sections.push({ title: 'Sprowokowanie', items: [
          { label:'Wykluczenie – w polu', action:'excl_drawn_field', phase:'positional' },
          { label:'Wykluczenie – z centra', action:'excl_drawn_center', phase:'positional' },
          { label:'Karny – w polu', action:'penalty_drawn_field', phase:'positional' },
          { label:'Karny – z centra', action:'penalty_drawn_center', phase:'positional' },
        ]});
        sections.push({ title: 'Rzuty karne', items: [
          { label:'Bramka z karnego', action:'goal_penalty', phase:'penalty', ok:true },
        ]});
      } else {
        sections.push({ title: 'Bramki', items: [
          { label:'z 2 metra', action:'goal_center_manup', phase:'man_up', ok:true },
          { label:'z 5 metra', action:'goal_5m', phase:'man_up', ok:true },
        ]});
        sections.push({ title: 'Asysta', items: [
          { label:'Asysta', action:'assist', phase:'man_up' },
        ]});
        sections.push({ title: 'Strata piłki', items: [
          { label:'Obrona bramkarza', action:'shot_saved', phase:'man_up', danger:true },
          { label:'Niecelny rzut – strata', action:'miss_turnover', phase:'man_up', danger:true },
          { label:'Niecelny rzut – 30s', action:'miss_reset', phase:'man_up' },
          { label:'Niecelne podanie – strata', action:'bad_pass_turnover', phase:'man_up', danger:true },
          { label:'Niecelne podanie – bez straty', action:'bad_pass_no', phase:'man_up' },
          { label:'Strata 1:1', action:'turnover_1v1', phase:'man_up', danger:true },
          { label:'Koniec czasu', action:'shot_clock', phase:'man_up', danger:true },
        ]});
      }

      // Render sekcji
      sections.forEach(sec => {
        const title = document.createElement('div');
        title.className = 'subhead';
        title.textContent = sec.title;
        const grid = document.createElement('div');
        grid.className = 'grid';
        sec.items.forEach(it => {
          const b = document.createElement('button');
          b.className = 'btn' + (it.danger ? ' danger' : it.ok ? ' primary' : '');
          b.setAttribute('data-action', it.action);
          if (it.phase) b.setAttribute('data-phase', it.phase);
          b.textContent = it.label;
          grid.appendChild(b);
        });
        host.appendChild(title);
        host.appendChild(grid);
      });
    }

    function pick(p){ STATE.selected=p; document.getElementById('picked').textContent = p?`#${p.number} ${p.name}`:'—'; renderPlayers(); }

    function setQuarter(q){
      if(!CAN_WRITE) return toast('Wpisz PIN i odblokuj');
      STATE.settings.Quarter = q; updateHeader();
      google.script.run.withSuccessHandler(s=>{ STATE.settings=s; updateHeader(); })
        .withFailureHandler(e=>toast(e.message||'Błąd')).setQuarter(q, EDIT_PIN);
    }

    function setMatch(mId){
      if(!CAN_WRITE) return toast('Wpisz PIN i odblokuj');
      STATE.settings.ActiveMatch = mId; updateHeader();
      google.script.run.withSuccessHandler(s=>{ STATE.settings=s; updateHeader(); refreshStats(); })
        .withFailureHandler(e=>toast(e.message||'Błąd')).setActiveMatch(mId, EDIT_PIN);
    }

    function undoLast(){
      if(!CAN_WRITE) return toast('Wpisz PIN i odblokuj');
      google.script.run.withSuccessHandler(res=> toast(res.ok?'Cofnięto':(res.reason||'Brak do cofnięcia')))
        .withFailureHandler(e=>toast(e.message||'Błąd'))
        .undoLastEvent(3, EDIT_PIN);
    }

    function submitEvent(def){
      if(!STATE.selected) return toast('Wybierz zawodnika');
      if(!CAN_WRITE) return toast('Brak uprawnień');
      // Faza pobierana z atrybutu data-phase przycisku (jeśli brak – domyślnie positional)
      const phase = (def && def.phase) || 'positional';
      const base = {
        match_id: STATE.settings.ActiveMatch,
        quarter: STATE.settings.Quarter,
        team: 'my',
        player_id: STATE.selected.player_id,
        player_name: STATE.selected.name,
        note: document.getElementById('note').value || '',
        phase
      };
      // mapowanie nowych akcji
      const flags = {};
      const act = def?.action || def; // pozwala wołać submitEvent({action:'...', phase:'...'})
      switch(act){
        case 'goal_play_pos': flags.is_goal_from_play=1; break;
        case 'goal_center_manup': flags.is_goal_from_center=1; break;
        case 'goal_5m': flags.is_goal_5m=1; break;
        case 'assist': flags.is_assist=1; break;
        case 'shot_saved': flags.is_shot_saved_gk=1; break;
        case 'miss_turnover': flags.is_shot_miss_turnover=1; break;
        case 'miss_reset': flags.is_shot_miss_reset30=1; break;
        case 'bad_pass_turnover': flags.is_bad_pass_turnover=1; break;
        case 'bad_pass_no': flags.is_bad_pass_no_turnover=1; break;
        case 'turnover_1v1': flags.is_turnover_1v1=1; break;
        case 'shot_clock': flags.is_shot_clock_violation=1; break;
        case 'penalty_drawn_field': flags.is_penalty_drawn=1; base.penalty_drawn_location='field'; break;
        case 'penalty_drawn_center': flags.is_penalty_drawn=1; base.penalty_drawn_location='center'; break;
        case 'excl_drawn_field': flags.is_excl_drawn=1; base.excl_drawn_location='field'; break;
        case 'excl_drawn_center': flags.is_excl_drawn=1; base.excl_drawn_location='center'; break;
        case 'excl_comm_field': flags.is_excl_committed=1; base.excl_committed_location='field'; break;
        case 'excl_comm_center': flags.is_excl_committed=1; base.excl_committed_location='center'; break;
        case 'pen_comm_field': flags.is_penalty_committed=1; base.penalty_committed_location='field'; break;
        case 'pen_comm_center': flags.is_penalty_committed=1; base.penalty_committed_location='center'; break;
        case 'no_return': flags.is_no_return=1; break;
        case 'steal': flags.is_steal=1; break;
        case 'block': flags.is_block_hand=1; break;
        case 'no_block': flags.is_no_block=1; break;
        case 'goal_penalty': flags.is_goal_5m=1; base.phase='penalty'; break;
        default: break;
      }
      const payload = { ...base, ...flags };
      enqueueEvent(payload);
      document.getElementById('note').value = '';
      toast('Zapisano');
    }

    function highlightQuarterButtons() {
      const q = Number(STATE.settings?.Quarter || 0);
      [1,2,3,4].forEach(n => {
        const btn = document.getElementById('q'+n);
        if (!btn) return;
        btn.classList.toggle('selected', q === n);
      });
    }

    function updateHeader(){
      document.getElementById('quarter').textContent = STATE.settings?.Quarter ?? '—';
      highlightQuarterButtons();

      const sel = document.getElementById('matchSel'); sel.innerHTML='';
      STATE.matches.forEach(m=>{
        const label = m.opponent ? m.opponent : m.match_id;
        const o = el('option', { value:m.match_id }, label);
        const selectedId = STATE.settings?.ActiveMatch;
        if(m.match_id===selectedId) o.selected=true;
        sel.appendChild(o);
      });

      const es = document.getElementById('editState');
      if (es) es.textContent = CAN_WRITE ? 'ON' : 'OFF';

      const alwaysEnabled = new Set(['tabScore','tabStats','tabAdmin','statsQuarter','matchSel','burger','openIndex']);
      document.querySelectorAll('button,select,input').forEach(node => {
        const id = node.id || '';
        node.disabled = !CAN_WRITE && !alwaysEnabled.has(id);
      });
    }

    function startPolling(){
      setInterval(() => {
        google.script.run.withSuccessHandler(s => {
          const changed = !STATE.settings || s.ActiveMatch !== STATE.settings.ActiveMatch || s.Quarter !== STATE.settings.Quarter;
          if (changed) {
            STATE.settings = s; updateHeader(); refreshStats();
          }
        }).getSettings();
      }, 2000);
    }

    /* ---------- stats ---------- */

    function refreshStats() {
      const matchId = STATE.viewMatchId || STATE.settings?.ActiveMatch;
      if (!matchId) return;
      setLoading(true);
      google.script.run.withSuccessHandler(stats => {
        STATE.stats = stats;
        renderStats();
        setLoading(false);
      }).withFailureHandler(e=>{ setLoading(false); toast(e.message||'Błąd statystyk'); })
        .getMatchStats(matchId);
    }

    function flagOrder(flags) {
      const prefer = ['is_goal_from_play','is_goal_5m','is_goal_man_up','is_goal_counter','is_goal_putback','is_assist','is_excl_drawn','is_excl_committed','is_turnover','is_shot_out','is_steal','is_block_hand','is_press_win','is_interception','is_bad_pass_2m','is_no_return'];
      const set = new Set(flags);
      return prefer.filter(f=>set.has(f)).concat(flags.filter(f=>!prefer.includes(f)));
    }

    function sumGoals(obj) {
      const keys = ['is_goal_from_play','is_goal_5m','is_goal_man_up','is_goal_counter','is_goal_putback'];
      return keys.reduce((a,k)=>a+(Number(obj?.[k]||0)),0);
    }

    function buildTable(rows, title, totalsObj, flags) {
      const table = el('table');
      const thead = el('thead');
      // Grupowanie kolumn: Atak pozycyjny / Przewaga / Karny / Obrona
      const groups = [
        { name: 'Atak pozycyjny', keys: ['is_goal_from_play','is_assist','is_shot_saved_gk','is_shot_miss_turnover','is_shot_miss_reset30','is_bad_pass_turnover','is_bad_pass_no_turnover','is_turnover_1v1','is_shot_clock_violation'] },
        { name: 'Przewaga', keys: ['is_goal_from_center','is_goal_5m'] },
        { name: 'Karny', keys: ['is_goal_5m','is_penalty_drawn','is_penalty_committed'] },
        { name: 'Obrona', keys: ['is_no_return','is_excl_committed','is_steal','is_block_hand','is_no_block'] }
      ];
      // Top row: group headers
      const trg = el('tr');
      trg.appendChild(el('th', { rowspan: '2' }, title || 'Zawodnik'));
      groups.forEach(g => {
        const span = g.keys.filter(k => flags.includes(k)).length;
        if (span > 0) trg.appendChild(el('th', { colspan: String(span) }, g.name));
      });
      trg.appendChild(el('th', { rowspan: '2' }, 'G (suma)'));
      thead.appendChild(trg);
      // Second row: individual flag labels
      const trf = el('tr');
      groups.forEach(g => {
        g.keys.forEach(k => { if (flags.includes(k)) trf.appendChild(el('th', {}, FLAG_LABELS[k] || k)); });
      });
      thead.appendChild(trf);
      table.appendChild(thead);

      const tbody = el('tbody');
      rows.forEach(r=>{
        const tr = el('tr',
          {}, el('td', {}, r.name),
          ...flags.map(f=> el('td', {}, String(r[f]||0))),
          el('td', {}, String(sumGoals(r)))
        );
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      if (totalsObj) {
        const tfoot = el('tfoot');
        const trf = el('tr',
          {}, el('td', { style:'font-weight:700;' }, 'Razem'),
          ...flags.map(f=> el('td', { style:'font-weight:700;' }, String(totalsObj[f]||0))),
          el('td', { style:'font-weight:700;' }, String(sumGoals(totalsObj)))
        );
        tfoot.appendChild(trf);
        table.appendChild(tfoot);
      }
      return table;
    }

    function renderStats() {
      if (!STATE.stats) return;
      const mode = document.getElementById('statsQuarter').value;
      const flags = flagOrder(STATE.stats.flags);
      const playersById = Object.fromEntries(STATE.stats.players.map(p=>[p.player_id,p]));

      const s = STATE.stats.scores;
      const scoreText = `Q1 ${s['1'].my}:${s['1'].opp} • Q2 ${s['2'].my}:${s['2'].opp} • Q3 ${s['3'].my}:${s['3'].opp} • Q4 ${s['4'].my}:${s['4'].opp} • F ${s.final.my}:${s.final.opp}`;
      document.getElementById('scoreSummary').textContent = scoreText;

      const container = document.getElementById('statsTables');
      container.innerHTML = '';

      if (mode === 'split') {
        ['1','2','3','4'].forEach(q=>{
          const byPid = STATE.stats.perPlayerByQ[q] || {};
          const rows = Object.entries(byPid).map(([pid,vals])=>{
            const p = playersById[pid] || {name:'?'};
            return { name: `#${p.number||''} ${p.name||pid}`, ...vals };
          }).sort((a,b)=> (sumGoals(b)-sumGoals(a)));
          const totalsQ = STATE.stats.totalsByQ[q] || {};
          container.appendChild(el('div', { class:'muted' }, `Kwarta ${q}`));
          container.appendChild(buildTable(rows, 'Zawodnik', totalsQ, flags));
          container.appendChild(el('div', { class:'small' }, ' '));
        });
      } else {
        const byPid = (mode === 'all')
          ? STATE.stats.perPlayerAll
          : (STATE.stats.perPlayerByQ[mode] || {});
        const totals = (mode === 'all')
          ? (STATE.stats.totalsAll || {})
          : (STATE.stats.totalsByQ[mode] || {});
        const rows = Object.entries(byPid).map(([pid,vals])=>{
          const p = playersById[pid] || {name:'?'};
          return { name: `#${p.number||''} ${p.name||pid}`, ...vals };
        }).sort((a,b)=> (sumGoals(b)-sumGoals(a)));
        container.appendChild(buildTable(rows, 'Zawodnik', totals, flags));
      }
    }

    function saveScore() {
      if(!CAN_WRITE) return toast('Wpisz PIN i odblokuj');
      const q = document.getElementById('scoreQuarter').value;
      const my = Number(document.getElementById('scoreMy').value||0);
      const opp = Number(document.getElementById('scoreOpp').value||0);
      const matchId = STATE.settings?.ActiveMatch;
      if (!matchId) return;

      setLoading(true);
      google.script.run.withSuccessHandler(scores=>{
        STATE.stats = { ...(STATE.stats||{}), scores };
        renderStats();
        toast('Zapisano wynik');
        setLoading(false);
      }).withFailureHandler(e=>{ setLoading(false); toast(e.message||'Błąd zapisu wyniku'); })
        .setQuarterScore(matchId, q, my, opp, EDIT_PIN);
    }

    /* ---------- view switching ---------- */

    function switchMode(mode) {
      const score = document.getElementById('modeScore');
      const stats = document.getElementById('modeStats');
      const admin = document.getElementById('modeAdmin');
      if (mode === 'stats') {
        score.classList.add('hidden'); stats.classList.remove('hidden'); admin.classList.add('hidden');
        document.getElementById('tabScore').classList.remove('primary');
        document.getElementById('tabStats').classList.add('primary');
        document.getElementById('tabAdmin').classList.remove('primary');
        const sc = document.getElementById('scoreControls'); if (sc) sc.style.display='none';
        refreshStats();
      } else if (mode === 'admin') {
        if (!CAN_WRITE) { toast('Tylko editor'); return; }
        score.classList.add('hidden'); stats.classList.add('hidden'); admin.classList.remove('hidden');
        document.getElementById('tabScore').classList.remove('primary');
        document.getElementById('tabStats').classList.remove('primary');
        document.getElementById('tabAdmin').classList.add('primary');
        buildRosterForm();
        const sc = document.getElementById('scoreControls'); if (sc) sc.style.display='none';
      } else {
        stats.classList.add('hidden'); admin.classList.add('hidden'); score.classList.remove('hidden');
        document.getElementById('tabStats').classList.remove('primary');
        document.getElementById('tabAdmin').classList.remove('primary');
        document.getElementById('tabScore').classList.add('primary');
        const sc = document.getElementById('scoreControls'); if (sc) sc.style.display='flex';
      }
    }

    /* ---------- admin: match + roster form ---------- */
    function buildRosterForm() {
      // Pobierz pełną listę z arkusza Players (niezależnie od aktywnego rosteru)
      setLoading(true);
      google.script.run.withSuccessHandler(players => {
        const list = Array.isArray(players) && players.length ? players : (STATE.players || []);
        ROSTER_FORM = list.map(p => ({ player_id: p.player_id, name: p.name, team: p.team || 'my', number: '' }));
        renderRosterForm(); setLoading(false);
      }).withFailureHandler(() => {
        const list = STATE.players || [];
        ROSTER_FORM = list.map(p => ({ player_id: p.player_id, name: p.name, team: p.team || 'my', number: '' }));
        renderRosterForm(); setLoading(false);
      }).getPlayers();
      const btn = document.getElementById('copyPrev');
      if (btn) btn.onclick = copyRosterFromPrevious;
    }

    function renderRosterForm() {
      const host = document.getElementById('rosterPick');
      host.innerHTML = '';
      const wrapper = document.createElement('div');
      wrapper.className = 'grid';
      ROSTER_FORM.forEach((p, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        const label = document.createElement('div');
        label.textContent = p.name;
        label.style.marginBottom = '6px';
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.gap = '8px';
        const num = document.createElement('input');
        num.className = 'input'; num.placeholder = '#'; num.style.width = '80px';
        num.value = p.number;
        num.oninput = () => { p.number = num.value; renderRosterPreview(); };
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = p.number !== '';
        chk.onchange = () => { if (!chk.checked) { p.number = ''; num.value = ''; } renderRosterPreview(); };
        row.appendChild(num);
        row.appendChild(chk);
        card.appendChild(label);
        card.appendChild(row);
        wrapper.appendChild(card);
      });
      host.appendChild(wrapper);
      renderRosterPreview();
    }

    function renderRosterPreview() {
      const pick = ROSTER_FORM.filter(p => String(p.number||'').trim() !== '');
      pick.sort((a,b)=> Number(a.number||0) - Number(b.number||0));
      const host = document.getElementById('rosterPreview');
      host.innerHTML = '';
      if (!pick.length) { host.textContent = 'Brak zawodników w składzie'; return; }
      const ul = document.createElement('ul');
      pick.forEach(p => {
        const li = document.createElement('li');
        li.textContent = `#${p.number} ${p.name}`;
        ul.appendChild(li);
      });
      host.appendChild(ul);
    }

    function saveMatchWithRoster() {
      if (!CAN_WRITE) { toast('Tylko editor'); return; }
      const match = {
        match_id: document.getElementById('m_id').value.trim(),
        date: document.getElementById('m_date').value.trim(),
        opponent: document.getElementById('m_opponent').value.trim(),
        place: document.getElementById('m_place').value.trim(),
      };
      const roster = ROSTER_FORM
        .filter(p => String(p.number||'').trim() !== '')
        .map(p => ({ player_id: p.player_id, number: p.number, name: p.name, team: p.team || 'my' }));
      if (!match.match_id) { toast('Podaj match_id'); return; }
      if (!roster.length) { toast('Wybierz zawodników i numery'); return; }
      setLoading(true);
      google.script.run.withSuccessHandler(res => {
        toast('Zapisano mecz i skład');
        if (res.matches) STATE.matches = res.matches;
        if (res.roster) STATE.players = res.roster;
        // Ustaw aktywny mecz na nowo zapisany
        STATE.settings.ActiveMatch = match.match_id; updateHeader(); renderPlayers();
        setLoading(false);
      }).withFailureHandler(e => { setLoading(false); toast(e.message || 'Błąd zapisu'); })
        .addMatchAndRoster(match, roster, EDIT_PIN);
    }

    function copyRosterFromPrevious() {
      const newId = document.getElementById('m_id').value.trim();
      if (!newId) { toast('Najpierw wpisz match_id'); return; }
      setLoading(true);
      google.script.run.withSuccessHandler(prev => {
        if (!Array.isArray(prev) || !prev.length) { toast('Brak poprzedniego składu'); return; }
        ROSTER_FORM = prev.map(p => ({ player_id: p.player_id, name: p.name, team: p.team || 'my', number: String(p.number || '') }));
        renderRosterForm(); setLoading(false);
      }).withFailureHandler(e => { setLoading(false); toast(e.message || 'Brak poprzedniego meczu'); })
        .getPreviousMatchRoster(newId);
    }

    /* ---------- init ---------- */

    function init(){
      google.script.run.withSuccessHandler(data=>{
        STATE = { ...STATE, ...data };
        // enable edit automatically if role=editor
        if ((STATE.user?.role || '').toLowerCase() === 'editor') {
          CAN_WRITE = true;
        }
        // Używaj wyłącznie składu per mecz (Match_Roster). Jeśli brak aktywnego meczu lub rosteru, lista pusta.
        STATE.players = (STATE.rosterActive && STATE.rosterActive.length) ? STATE.rosterActive : [];
        renderPlayers(); renderButtons(); updateHeader();
        if(STATE.players.length) pick(STATE.players[0]);
        startPolling();
        refreshStats();
      }).withFailureHandler(e=>alert(e.message||'Błąd')).getBootstrap();
      // Wymuś tryb edycji bez PIN
      CAN_WRITE = true; updateHeader();

      // drawer (burger)
      const drawer = document.getElementById('drawer');
      const burger = document.getElementById('burger');
      const overlay = document.getElementById('drawerOverlay');
      const closeDrawer = () => { drawer.style.right = '-320px'; if (overlay) overlay.style.display='none'; };
      const openDrawer = () => { drawer.style.right = '0px'; if (overlay) overlay.style.display='block'; };
      burger.onclick = () => { if (drawer.style.right === '0px') closeDrawer(); else openDrawer(); };
      const closeBtn = document.getElementById('closeDrawer'); if (closeBtn) closeBtn.onclick = closeDrawer;
      if (overlay) overlay.onclick = closeDrawer;
      // close drawer when switching modes
      ['tabScore','tabStats','tabAdmin'].forEach(id => {
        const elx = document.getElementById(id); if (elx) elx.onclick = () => { switchMode(id==='tabStats'?'stats':id==='tabAdmin'?'admin':'score'); closeDrawer(); };
      });
      // przełącznik Atak: segment buttons
      const seg = document.getElementById('attackSeg');
      if (seg) {
        seg.addEventListener('click', (e)=>{
          const btn = e.target.closest('button[data-mode]');
          if (!btn) return;
          seg.querySelectorAll('button').forEach(b=> b.classList.remove('active'));
          btn.classList.add('active');
          renderButtons();
        });
      }
      const openIndex = document.getElementById('openIndex');
      if (openIndex) openIndex.onclick = () => {
        google.script.run.withSuccessHandler(res => { if (res?.url) window.open(res.url, '_blank'); else toast('Brak Index'); }).getIndexUrl();
      };

      document.getElementById('q1').onclick = ()=>setQuarter(1);
      document.getElementById('q2').onclick = ()=>setQuarter(2);
      document.getElementById('q3').onclick = ()=>setQuarter(3);
      document.getElementById('q4').onclick = ()=>setQuarter(4);
      document.getElementById('undo').onclick = undoLast;
      const collapseAll = document.getElementById('collapseAll');
      // usunięto "Zwiń wszystkie"
      document.getElementById('matchSel').onchange = (e)=> {
        const val = e.target.value;
        setMatch(val);
        // po zmianie meczu pobierz roster i staty dla nowego aktywnego meczu
        google.script.run.withSuccessHandler(r=>{
          STATE.players = (Array.isArray(r) && r.length) ? r : [];
          renderPlayers();
          refreshStats();
        }).getRoster(val);
      };

      // event delegation dla klików akcji – łapie wszystkie przyciski z data-action
      document.getElementById('modeScore').addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        // szybki feedback kliknięcia
        btn.classList.add('flash');
        setTimeout(()=> btn.classList.remove('flash'), 120);
        const action = btn.getAttribute('data-action');
        const phase = btn.getAttribute('data-phase') || undefined;
        submitEvent({ action, phase });
      });

      // usunięto PIN/lock – edycja zawsze ON

      document.getElementById('tabScore').onclick = ()=> switchMode('score');
      document.getElementById('tabStats').onclick = ()=> switchMode('stats');
      document.getElementById('tabAdmin').onclick = ()=> switchMode('admin');
      document.getElementById('statsQuarter').onchange = renderStats;
      document.getElementById('saveScore').onclick = saveScore;
      const saveBtn = document.getElementById('saveMatch'); if (saveBtn) saveBtn.onclick = saveMatchWithRoster;
      // saveMatch will be wired once admin view is built
    }
    init();
  </script>
</body>
</html>